# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: circleci/node:10

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/mongo:3.4.4

    working_directory: ~/app

    steps:
      - checkout

      - restore_cache:
          keys:
            - terraform_bin-{{ checksum "./terraform/terraform_version" }}

      - restore_cache:
          keys:
            - google_cloud_sdk_zip

      - run:
          name: install node modules
          command: |
            cd $HOME/app/functions/javascript/fetch-from-big-query && npm install
            cd $HOME/app/functions/javascript/sns-to-pubsub && npm install

      - run:
          name: Run linter
          command: |
            cd $HOME/app/functions/javascript/fetch-from-big-query && npm run lint
            cd $HOME/app/functions/javascript/sns-to-pubsub && npm run lint

      - run:
          name: Run tests
          command: |
            cd $HOME/app/functions/javascript/fetch-from-big-query && npm test
            cd $HOME/app/functions/javascript/sns-to-pubsub && npm test

      - run:
          name: zip artifacts
          command: |
            if [ $CIRCLE_BRANCH = 'setup/circle_ci' ] || [ $CIRCLE_BRANCH == 'master' ] || [ $CIRCLE_BRANCH == 'staging' ]; then
               echo "On branch $CIRCLE_BRANCH, building artifacts."

               cd $HOME/app/functions/javascript/fetch-from-big-query
               echo $CIRCLE_SHA1 > last_commit.txt
               zip -rq $HOME/fetch_from_big_query_$CIRCLE_SHA1.zip .


               cd $HOME/app/functions/javascript/sns-to-pubsub
               echo $CIRCLE_SHA1 > last_commit.txt
               zip -rq $HOME/sns_to_pubsub_$CIRCLE_SHA1.zip .

            fi

      - run:
          name: install gcloud cli
          command: |
            if [ ! -f google-cloud-sdk-268.0.0-linux-x86_64.tar.gz ]; then
            wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-268.0.0-linux-x86_64.tar.gz
            fi
            tar xvzf tar xvzf google-cloud-sdk-268.0.0-linux-x86_64.tar.gz
            ./google-cloud-sdk/install.sh --rc-path=~/bin/google

      - save_cache:
          key: google_cloud_sdk_zip
          paths:
            - google-cloud-sdk-268.0.0-linux-x86_64.tar.gz

      - run:
          name: upload zipped artifacts to cloud storage
          command: |

            if [ $CIRCLE_BRANCH = 'setup/circle_ci' ] || [ $CIRCLE_BRANCH == 'master' ] || [ $CIRCLE_BRANCH == 'staging' ]; then
               echo "On branch $CIRCLE_BRANCH, uploading artifacts."

               cd $HOME

               /home/circleci/bin/google gcloud --help
            fi